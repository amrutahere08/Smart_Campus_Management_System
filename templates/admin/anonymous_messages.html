{% extends 'base.html' %}

{% block title %}Anonymous Messages - Admin{% endblock %}

{% block content %}
<!-- Hero Section with Gradient Background -->
<section
    style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.9) 50%, rgba(237, 100, 166, 0.95) 100%); padding: 3rem 0; position: relative; overflow: hidden;">
    <div class="container" style="max-width: 1200px; margin: 0 auto; position: relative; z-index: 2; padding: 0 2rem;">
        <div style="text-align: center; color: white;" class="fade-in-up">
            <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: -0.01em;">
                <i class="fas fa-comment-dots"></i> Anonymous Messages & Complaints
            </h1>
            <p style="font-size: 1.1rem; opacity: 0.9; font-weight: 300;">
                View and manage anonymous feedback from users
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-4" style="gap: 1.5rem; margin-top: 2.5rem;">
            <div class="stat-card-modern fade-in-up"
                style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95)); padding: 1.75rem; border-radius: 12px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                <div
                    style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    {{ total_messages }}
                </div>
                <div
                    style="color: #64748b; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Total Messages
                </div>
            </div>

            <div class="stat-card-modern fade-in-up"
                style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95)); padding: 1.75rem; border-radius: 12px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transition-delay: 0.1s; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                <div
                    style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem; background: linear-gradient(135deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    {{ pending_count }}
                </div>
                <div
                    style="color: #64748b; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Pending
                </div>
            </div>

            <div class="stat-card-modern fade-in-up"
                style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95)); padding: 1.75rem; border-radius: 12px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transition-delay: 0.2s; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                <div
                    style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem; background: linear-gradient(135deg, #06b6d4, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    {{ reviewed_count }}
                </div>
                <div
                    style="color: #64748b; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Reviewed
                </div>
            </div>

            <div class="stat-card-modern fade-in-up"
                style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95)); padding: 1.75rem; border-radius: 12px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transition-delay: 0.3s; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                <div
                    style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem; background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    {{ resolved_count }}
                </div>
                <div
                    style="color: #64748b; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    Resolved
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Filters and Messages Section -->
<section style="padding: 3rem 0; background: linear-gradient(to bottom, #f8fafc, #ffffff);">
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <!-- Filters Card -->
        <div class="card fade-in-up"
            style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 2rem;">
            <form method="GET" class="row g-3"
                style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="status" class="form-label"
                        style="font-weight: 600; color: #1e293b; margin-bottom: 0.5rem; display: block;">Status</label>
                    <select name="status" id="status" class="form-select"
                        style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; width: 100%;">
                        <option value="all" {% if status_filter=='all' %}selected{% endif %}>All</option>
                        <option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending</option>
                        <option value="reviewed" {% if status_filter=='reviewed' %}selected{% endif %}>Reviewed</option>
                        <option value="resolved" {% if status_filter=='resolved' %}selected{% endif %}>Resolved</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label for="category" class="form-label"
                        style="font-weight: 600; color: #1e293b; margin-bottom: 0.5rem; display: block;">Category</label>
                    <select name="category" id="category" class="form-select"
                        style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; width: 100%;">
                        <option value="all" {% if category_filter=='all' %}selected{% endif %}>All</option>
                        <option value="complaint" {% if category_filter=='complaint' %}selected{% endif %}>Complaint
                        </option>
                        <option value="suggestion" {% if category_filter=='suggestion' %}selected{% endif %}>Suggestion
                        </option>
                        <option value="feedback" {% if category_filter=='feedback' %}selected{% endif %}>Feedback
                        </option>
                        <option value="other" {% if category_filter=='other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button type="submit" class="btn"
                        style="padding: 0.75rem 2rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <a href="{{ url_for('admin.anonymous_messages') }}" class="btn"
                        style="padding: 0.75rem 2rem; background: #e2e8f0; color: #1e293b; border: none; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.2s;">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </form>
        </div>

        <!-- Messages List -->
        <div class="card fade-in-up"
            style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
            {% if messages %}
            {% for message in messages %}
            <div class="message-card"
                style="padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; transition: all 0.3s;">
                <div
                    style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                        <span class="badge"
                            style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: {{ 'linear-gradient(135deg, #f59e0b, #ef4444)' if message.status == 'pending' else 'linear-gradient(135deg, #06b6d4, #3b82f6)' if message.status == 'reviewed' else 'linear-gradient(135deg, #10b981, #059669)' }}; color: white;">
                            {{ message.status|upper }}
                        </span>
                        <span class="badge"
                            style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white;">
                            {{ message.category|upper }}
                        </span>
                        <small style="color: #64748b; font-size: 0.9rem;">
                            <i class="fas fa-clock"></i> {{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}
                        </small>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn-sm" onclick="updateStatus({{ message.id }}, 'reviewed')"
                            style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #06b6d4, #3b82f6); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-eye"></i> Reviewed
                        </button>
                        <button class="btn-sm" onclick="updateStatus({{ message.id }}, 'resolved')"
                            style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-check"></i> Resolved
                        </button>
                        <button class="btn-sm" onclick="deleteMessage({{ message.id }})"
                            style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 1.25rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p
                        style="margin: 0; color: #1e293b; font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
                        {{ message.message }}</p>
                </div>
                {% if message.admin_notes %}
                <div
                    style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 1.25rem; border-radius: 8px; border-left: 4px solid #667eea;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #667eea; font-size: 0.9rem;">
                        <i class="fas fa-reply"></i> Admin Response:
                    </p>
                    <p style="margin: 0; color: #1e293b; font-size: 0.95rem; line-height: 1.6;">{{ message.admin_notes
                        }}</p>
                </div>
                {% else %}
                <div>
                    <button class="btn-sm" onclick="showResponseForm({{ message.id }})"
                        style="padding: 0.5rem 1.25rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-reply"></i> Add Response
                    </button>
                    <div id="response-form-{{ message.id }}" style="display: none; margin-top: 1rem;">
                        <textarea class="form-control" id="response-text-{{ message.id }}" rows="3"
                            placeholder="Enter your response..."
                            style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; margin-bottom: 0.75rem;"></textarea>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-sm" onclick="submitResponse({{ message.id }})"
                                style="padding: 0.5rem 1.25rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button class="btn-sm" onclick="hideResponseForm({{ message.id }})"
                                style="padding: 0.5rem 1.25rem; background: #e2e8f0; color: #1e293b; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div style="text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-inbox" style="font-size: 4rem; color: #cbd5e1; margin-bottom: 1.5rem;"></i>
                <p style="color: #64748b; font-size: 1.1rem; margin: 0;">No messages found</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
    function updateStatus(messageId, status) {
        if (!confirm(`Are you sure you want to mark this message as ${status}?`)) {
            return;
        }

        fetch(`/api/anonymous/messages/${messageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating status: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status');
            });
    }

    function deleteMessage(messageId) {
        if (!confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
            return;
        }

        fetch(`/api/anonymous/messages/${messageId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting message: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the message');
            });
    }

    function showResponseForm(messageId) {
        document.getElementById(`response-form-${messageId}`).style.display = 'block';
    }

    function hideResponseForm(messageId) {
        document.getElementById(`response-form-${messageId}`).style.display = 'none';
    }

    function submitResponse(messageId) {
        const responseText = document.getElementById(`response-text-${messageId}`).value.trim();

        if (!responseText) {
            alert('Please enter a response');
            return;
        }

        fetch(`/api/anonymous/messages/${messageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                admin_response: responseText,
                status: 'reviewed'
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error submitting response: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting the response');
            });
    }

    // Scroll animations
    document.addEventListener('DOMContentLoaded', function () {
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in-up').forEach((el) => {
            observer.observe(el);
        });
    });
</script>

<style>
    .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .fade-in-up.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .stat-card-modern {
        transition: all 0.3s ease;
    }

    .stat-card-modern:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3) !important;
    }

    .message-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }

    .btn:hover,
    .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn:active,
    .btn-sm:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .grid-4 {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }

    @media (max-width: 480px) {
        .grid-4 {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Voice Chat - Smart Campus{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; max-width: 800px;">
 <h2 style="color: white; margin-bottom: 1rem; text-align: center;"> Voice Chat</h2>

 <div class="card">
 <div class="card-body" style="text-align: center;">
 <div style="padding: 3rem;">
 <div style="font-size: 5rem; margin-bottom: 2rem;"></div>

 <button class="btn btn-primary" id="recordBtn" style="font-size: 1.2rem; padding: 1rem 2rem;">
 Hold to Speak
 </button>

 <div id="status" style="margin-top: 2rem; font-size: 1.1rem; color: var(--text-secondary);"></div>

 <div id="transcript"
 style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-height: 100px;">
 </div>
 </div>
 </div>
 </div>
</div>

<script>
 const recordBtn = document.getElementById('recordBtn');
 const status = document.getElementById('status');
 const transcript = document.getElementById('transcript');

 let mediaRecorder;
 let audioChunks = [];

 recordBtn.addEventListener('mousedown', startRecording);
 recordBtn.addEventListener('mouseup', stopRecording);
 recordBtn.addEventListener('touchstart', startRecording);
 recordBtn.addEventListener('touchend', stopRecording);

 async function startRecording() {
 status.textContent = ' Recording...';
 recordBtn.style.background = 'var(--danger-color)';

 try {
 const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
 mediaRecorder = new MediaRecorder(stream);
 audioChunks = [];

 mediaRecorder.addEventListener('dataavailable', event => {
 audioChunks.push(event.data);
 });

 mediaRecorder.start();
 } catch (error) {
 status.textContent = 'Error accessing microphone: ' + error.message;
 }
 }

 async function stopRecording() {
 if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

 status.textContent = 'â³ Processing...';
 recordBtn.style.background = '';

 mediaRecorder.stop();

 mediaRecorder.addEventListener('stop', async () => {
 const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
 const formData = new FormData();
 formData.append('audio', audioBlob, 'voice.wav');

 try {
 const response = await fetch('/api/voice/process', {
 method: 'POST',
 body: formData
 });

 if (response.ok) {
 const audioResponse = await response.blob();
 const audioUrl = URL.createObjectURL(audioResponse);
 const audio = new Audio(audioUrl);

 status.textContent = ' Playing response...';
 audio.play();

 audio.addEventListener('ended', () => {
 status.textContent = 'Ready to speak';
 });
 } else {
 const data = await response.json();
 status.textContent = ' Error: ' + data.error;
 if (data.user_message) {
 transcript.innerHTML = `<strong>You:</strong> ${data.user_message}<br><strong>Bot:</strong> ${data.response_text}`;
 }
 }
 } catch (error) {
 status.textContent = 'Error: ' + error.message;
 }

 // Stop all tracks
 mediaRecorder.stream.getTracks().forEach(track => track.stop());
 });
 }
</script>
{% endblock %}